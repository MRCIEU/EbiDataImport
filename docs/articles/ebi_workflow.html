<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EBI upload pipeline • GwasDataImport</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="EBI upload pipeline">
<meta property="og:description" content="GwasDataImport">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">GwasDataImport</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ebi_workflow.html">EBI upload pipeline</a>
    </li>
    <li>
      <a href="../articles/edit.html">Edit existing GWAS meta data</a>
    </li>
    <li>
      <a href="../articles/import_pipeline.html">Importing datasets into OpenGWAS</a>
    </li>
    <li>
      <a href="../articles/liftover.html">Automating liftover</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>EBI upload pipeline</h1>
            
      
      
      <div class="hidden name"><code>ebi_workflow.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">GwasDataImport</span>)
<span class="co">#&gt; API: public: http://gwas-api.mrcieu.ac.uk/</span>
<span class="co">#&gt; API: private: http://ieu-db-interface.epi.bris.ac.uk:8082/</span></pre></body></html></div>
<div id="objectives" class="section level2">
<h2 class="hasAnchor">
<a href="#objectives" class="anchor"></a>Objectives</h2>
<ol style="list-style-type: decimal">
<li>Download and format the data and metadata for an EBI dataset</li>
<li>Upload the formatted EBI data and metadata to OpenGWAS API</li>
<li>Determine which datasets in EBI are not present in OpenGWAS. Allow a ‘blacklist’ of EBI datasets to ignore. (TODO)</li>
</ol>
</div>
<div id="complete-workflow-for-one-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#complete-workflow-for-one-dataset" class="anchor"></a>Complete workflow for one dataset</h2>
<div class="sourceCode" id="cb2"><html><body><pre class="r">
<span class="co"># library(devtools)</span>
<span class="co"># load_all()</span>
<span class="co"># ieugwasr::select_api("dev2")</span>

<span class="co"># Authorise</span>
<span class="kw pkg">ieugwasr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/ieugwasr/man/get_access_token.html">get_access_token</a></span>()

<span class="co"># This is a small file, good for testing</span>
<span class="no">ebi_id</span> <span class="kw">&lt;-</span> <span class="st">"GCST005522"</span>
<span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">EbiDataset</span>$<span class="fu">new</span>(
    <span class="kw">ebi_id</span> <span class="kw">=</span> <span class="no">ebi_id</span>,
    <span class="kw">ftp_path</span><span class="kw">=</span><span class="fu"><a href="../reference/get_ftp_path.html">get_ftp_path</a></span>(<span class="no">ebi_id</span>),
    <span class="kw">igd_id</span> <span class="kw">=</span> <span class="st">"ebi-a-EBITEST"</span>,
    <span class="kw">wd</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"uploads/"</span>, <span class="no">ebi_id</span>)
)
<span class="no">x</span>$<span class="fu">pipeline</span>()</pre></body></html></div>
<p>Now delete:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">x</span>$<span class="fu">api_gwasdata_delete</span>()</pre></body></html></div>
</div>
<div id="workflow-for-all-datasets" class="section level2">
<h2 class="hasAnchor">
<a href="#workflow-for-all-datasets" class="anchor"></a>Workflow for all datasets</h2>
<p>To get a list of datasets that need to be imported:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">ignore_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scan.html">scan</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="kw">package</span><span class="kw">=</span><span class="st">"EbiDataImport"</span>, <span class="st">"extdata/ebi_ignore_list.txt"</span>), <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span>())
<span class="no">newdats</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/determine_new_datasets.html">determine_new_datasets</a></span>(<span class="kw">blacklist</span><span class="kw">=</span><span class="no">ignore_list</span>)
<span class="no">newdats</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/being_processed.html">being_processed</a></span>(<span class="no">newdats</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="no">.</span>, <span class="no">need</span>)</pre></body></html></div>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">ignore</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="kw">for</span>(<span class="no">i</span> <span class="kw">in</span> <span class="fl">2</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">newdats</span>))
{
    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="no">newdats</span>$<span class="no">ebi_id</span>[<span class="no">i</span>])
    <span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">EbiDataset</span>$<span class="fu">new</span>(
        <span class="kw">ebi_id</span> <span class="kw">=</span> <span class="no">newdats</span>$<span class="no">ebi_id</span>[<span class="no">i</span>],
        <span class="kw">ftp_path</span> <span class="kw">=</span> <span class="no">newdats</span>$<span class="no">path</span>[<span class="no">i</span>],
        <span class="kw">wd</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"uploads/"</span>, <span class="no">newdats</span>$<span class="no">ebi_id</span>[<span class="no">i</span>])
    )
    <span class="no">o</span> <span class="kw">&lt;-</span> <span class="no">x</span>$<span class="fu">pipeline</span>()
    <span class="kw">if</span>(! <span class="st">"NULL"</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">o</span>))
    {
        <span class="no">ignore</span><span class="kw">[[</span><span class="no">newdats</span>$<span class="no">ebi_id</span>[<span class="no">i</span>]]] <span class="kw">&lt;-</span> <span class="no">o</span>
    }
    <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">x</span>)
}</pre></body></html></div>
</div>
<div id="lookup-build" class="section level2">
<h2 class="hasAnchor">
<a href="#lookup-build" class="anchor"></a>Lookup build</h2>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">EbiDataset</span>$<span class="fu">new</span>(<span class="st">"GCST000755"</span>, <span class="kw">ftp_path</span><span class="kw">=</span><span class="fu"><a href="../reference/get_ftp_path.html">get_ftp_path</a></span>(<span class="st">"GCST000755"</span>))
<span class="no">x</span>$<span class="fu">download_dataset</span>()
<span class="no">x</span>$<span class="fu">format_dataset</span>()</pre></body></html></div>
</div>
<div id="suhre-proteins" class="section level2">
<h2 class="hasAnchor">
<a href="#suhre-proteins" class="anchor"></a>Suhre proteins</h2>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">ignore_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scan.html">scan</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="kw">package</span><span class="kw">=</span><span class="st">"EbiDataImport"</span>, <span class="st">"extdata/ebi_ignore_list.txt"</span>), <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span>())
<span class="no">newdats</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/determine_new_datasets.html">determine_new_datasets</a></span>(<span class="kw">blacklist</span><span class="kw">=</span><span class="no">ignore_list</span>, <span class="kw">exclude</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="no">suhre</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(<span class="no">newdats</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"Suhr"</span>, <span class="no">path</span>))
<span class="no">suhre</span> <span class="kw">&lt;-</span> <span class="fu">separate</span>(<span class="no">suhre</span>, <span class="no">path</span>, <span class="kw">sep</span><span class="kw">=</span><span class="st">"/"</span>, <span class="kw">into</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"p1"</span>,<span class="st">"p2"</span>,<span class="st">"p3"</span>), <span class="kw">remove</span><span class="kw">=</span><span class="no">F</span>)
<span class="no">temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="no">suhre</span>$<span class="no">p3</span>, <span class="kw">split</span><span class="kw">=</span><span class="st">"_"</span>))
<span class="no">suhre</span>$<span class="no">igd_id</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"prot-c-"</span>, <span class="no">temp</span>[,<span class="fl">1</span>], <span class="st">"_"</span>, <span class="no">temp</span>[,<span class="fl">2</span>])
<span class="no">suhre</span>$<span class="no">igd_id</span>

<span class="no">traitinfo</span> <span class="kw">&lt;-</span> <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span>(<span class="st">"http://metabolomics.helmholtz-muenchen.de/pgwas/download/probeanno.tsv"</span>, <span class="kw">sep</span><span class="kw">=</span><span class="st">"\t"</span>)
<span class="no">traitinfo</span>$<span class="no">igd_id</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"prot-c-"</span>, <span class="no">traitinfo</span>$<span class="no">seqid</span>)

<span class="no">suhre</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(<span class="no">suhre</span>, <span class="no">traitinfo</span>, <span class="kw">by</span><span class="kw">=</span><span class="st">"igd_id"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span>(<span class="no">suhre</span>, <span class="kw">file</span><span class="kw">=</span><span class="st">"suhre.rdata"</span>)

<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="st">"suhre.rdata"</span>)
<span class="kw">for</span>(<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">suhre</span>))
{
    <span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">EbiDataset</span>$<span class="fu">new</span>(
        <span class="kw">ebi_id</span><span class="kw">=</span><span class="no">suhre</span>$<span class="no">ebi_id</span>[<span class="no">i</span>],
        <span class="kw">ftp_path</span><span class="kw">=</span><span class="no">suhre</span>$<span class="no">path</span>[<span class="no">i</span>],
        <span class="kw">igd_id</span><span class="kw">=</span><span class="no">suhre</span>$<span class="no">igd_id</span>[<span class="no">i</span>],
        <span class="kw">traitname</span><span class="kw">=</span><span class="no">suhre</span>$<span class="no">target</span>[<span class="no">i</span>]
    )
    <span class="no">x</span>$<span class="fu">download_dataset</span>()
    <span class="no">x</span>$<span class="fu">pipeline</span>()
}</pre></body></html></div>
<p>Conclusion - they seem to be missing standard errors? Need to do this through the batch processing.</p>
</div>
<div id="ebi-ignore-list" class="section level2">
<h2 class="hasAnchor">
<a href="#ebi-ignore-list" class="anchor"></a>EBI Ignore list</h2>
<p>Need to figure out a solution for storing this. Many EBI datasets don’t have sufficient info to be included, so we need to ignore them instead of trying to upload them each time we look for new studies.</p>
<p>On the <code>ieu-ssd</code> machine where the original set of EBI datasets was downloaded and processed, this is how the first ignore list was determined:</p>
<pre><code><a href="https://dplyr.tidyverse.org/reference">library(dplyr)
a &lt;- read.csv("/data/ebi_gwascatalog/pmids.txt")
b &lt;- scan("/data/ebi_gwascatalog/study_ids.txt", character())
got &lt;- ieugwasr::gwasinfo() %&gt;% subset(., grepl("ebi-a", id)) %&gt;% {.$id} %&gt;% gsub("ebi-a-", "", .)
a$got &lt;- a$StudyID %in% got
head(a)
table(a$got)
table(a$got, a$Status)
ebi_ignore_list &lt;- a$StudyID[a$Status == "harmonised" &amp; !a$got]
write.table(ebi_ignore_list, file="ebi_ignore_list.txt", row=F, col=F, qu=F)</a></code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Gibran Hemani.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
